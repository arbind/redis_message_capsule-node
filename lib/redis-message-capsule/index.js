// Generated by CoffeeScript 1.4.0
(function() {
  var Channel, REDIS, RedisMessageCapsule, node_env,
    __bind = function(fn, me){ return function(){ return fn.apply(me, arguments); }; },
    __slice = [].slice;

  REDIS = require('redis-url');

  node_env = process.env.NODE_ENV || 'development';

  Channel = (function() {

    function Channel(name, redisClient) {
      this.name = name;
      this.redisClient = redisClient;
    }

    Channel.prototype.send = function(message) {
      var payload;
      payload = {
        'data': message
      };
      console.log(payload);
      console.log(JSON.stringify(payload));
      return this.redisClient.rpush(this.name, JSON.stringify(payload), function(err, count) {
        return console.log(count);
      });
    };

    return Channel;

  })();

  RedisMessageCapsule = (function() {

    RedisMessageCapsule.prototype.config = {};

    function RedisMessageCapsule() {
      this._handleNextMessage = __bind(this._handleNextMessage, this);

      var dbNumber;
      console.log("node_env: " + node_env);
      if (node_env === 'production') {
        dbNumber = 7;
      }
      if (node_env === 'development') {
        dbNumber = 8;
      }
      if (node_env === 'test') {
        dbNumber = 9;
      }
      dbNumber || (dbNumber = 9);
      this.redisClients = {};
      this.capsuleChannels = {};
      this.listenerClients = {};
      this.configuration = {
        redisURL: process.env.REDIS_URL || process.env.REDISTOGO_URL || 'redis://127.0.0.1:6379/',
        redisDBNumber: dbNumber
      };
      this.config = this.configuration;
    }

    RedisMessageCapsule.prototype.makeClientKey = function(url, dbNum) {
      return "" + url + "." + dbNum;
    };

    RedisMessageCapsule.prototype.makeChannelKey = function(name, url, dbNum) {
      return "" + name + "." + url + "." + dbNum;
    };

    RedisMessageCapsule.prototype.makeListenerKey = function(channels, url, dbNum) {
      return __slice.call(channels).concat([url], [dbNum]).join('.');
    };

    RedisMessageCapsule.prototype.channel = function(name, redisURL, dbNumber) {
      var channel, channelKey, clientKey, dbNum, redisClient, url;
      if (redisURL == null) {
        redisURL = null;
      }
      if (dbNumber == null) {
        dbNumber = -1;
      }
      url = redisURL || this.config.redisURL;
      dbNum = dbNumber;
      if (dbNum < 0) {
        dbNum = this.config.redisDBNumber;
      }
      channelKey = this.makeChannelKey(name, url, dbNum);
      if (this.capsuleChannels[channelKey] != null) {
        return this.capsuleChannels[channelKey];
      }
      clientKey = this.makeClientKey(url, dbNum);
      redisClient = this.redisClients[clientKey];
      if (redisClient == null) {
        redisClient = REDIS.connect(url);
        if (redisClient == null) {
          console.log("!!!\n!!! Can not connect to redis server at " + uri + "\n!!!");
          return null;
        }
        console.log("selecting " + dbNum);
        redisClient.select(dbNum);
        this.redisClients[clientKey] = redisClient;
      }
      channel = new Channel(name, redisClient);
      this.capsuleChannels[channelKey] = channel;
      return channel;
    };

    RedisMessageCapsule.prototype._handleNextMessage = function(redisClient, channelsArray, handler) {
      var _this = this;
      return redisClient.blpop.apply(redisClient, __slice.call(channelsArray).concat([0], [function(err, channel_element) {
        var channel, element, message, payload;
        console.log(err);
        console.log(channel_element);
        channel = channel_element[0];
        element = channel_element[1];
        try {
          payload = JSON.parse(element);
        } catch (ignoredException) {

        } finally {
          if (payload == null) {
            payload = {};
          }
        }
        message = payload.data;
        console.log("" + channel + ": " + message);
        if (typeof handler === "function" ? handler() : void 0) {
          handler(message);
        }
        return _this._handleNextMessage.apply(_this, [redisClient].concat(__slice.call(channelsArray), [handler]));
      }]));
    };

    RedisMessageCapsule.prototype.listen = function(channelsArray, cfg, handler) {
      var channels, dbNum, key, redisClient, url;
      if (cfg == null) {
        cfg = {};
      }
      if (handler == null) {
        handler = cfg;
        cfg = {
          redisUrl: null,
          dbNumber: -1
        };
      }
      if (channels instanceof Array) {
        channels = channelsArray;
      }
      if (channels == null) {
        channels = [channelsArray];
      }
      dbNum = cfg.dbNumber || -1;
      if (dbNum < 0) {
        dbNum = this.config.redisDBNumber;
      }
      url = cfg.redisUrl || this.config.redisURL;
      key = this.makeListenerKey(channels, url, dbNum);
      redisClient = this.listenerClients[key] || REDIS.connect(url);
      if (redisClient == null) {
        console.log("!!!\n!!! Can not connect to redis server at " + uri + "\n!!!");
        return null;
      }
      console.log("selecting " + dbNum);
      redisClient.select(dbNum);
      console.log("connected!");
      this.listenerClients[key] = redisClient;
      console.log("Listening for messages on " + (__slice.call(channels).join(', ')) + " [db: " + dbNum + "]");
      return this._handleNextMessage(redisClient, channels, handler);
    };

    return RedisMessageCapsule;

  })();

  module.exports = new RedisMessageCapsule;

}).call(this);
